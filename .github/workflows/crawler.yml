name: Get Hot News

on:
  schedule:
    # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
    # ‚ö†Ô∏è ËØïÁî®ÁâàËØ¥Êòé / Trial Mode
    # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
    #
    # üîÑ ËøêË°åÊú∫Âà∂ / How it works:
    #    - ÊØè‰∏™Âë®Êúü‰∏∫ 7 Â§©ÔºåÂ±äÊó∂Ëá™Âä®ÂÅúÊ≠¢
    #    - ËøêË°å "Check In" ‰ºöÈáçÁΩÆÂë®ÊúüÔºàÈáçÊñ∞ÂºÄÂßã 7 Â§©ÂÄíËÆ°Êó∂ÔºåËÄåÈùûÁ¥ØÂä†Ôºâ
    #    - Each cycle is 7 days, then auto-stops
    #    - "Check In" resets the cycle (restarts 7-day countdown, not cumulative)
    #
    # üí° ËÆæËÆ°ÂàùË°∑ / Why this design:
    #    Â¶ÇÊûú 7 Â§©ÈÉΩÂøò‰∫ÜÁ≠æÂà∞ÔºåÊàñËÆ∏Ëøô‰∫õËµÑËÆØÂØπ‰Ω†Êù•ËØ¥Âπ∂ÈùûÂàöÈúÄ
    #    ÈÄÇÊó∂ÁöÑÊöÇÂÅúÔºåËÉΩÂ∏Æ‰Ω†‰ªé‰ø°ÊÅØÊµÅ‰∏≠ÊäΩÁ¶ªÔºåÁªôÂ§ßËÑëÁïôÂá∫ÂñòÊÅØÁöÑÁ©∫Èó¥
    #    If you forget for 7 days, maybe you don't really need it
    #    A timely pause helps you detach from the stream and gives your mind space
    #
    # üôè ÁèçÊÉúËµÑÊ∫ê / Respect shared resources:
    #    GitHub Actions ÊòØÂπ≥Âè∞Êèê‰æõÁöÑÂÖ¨ÂÖ±ËµÑÊ∫êÔºåÊØèÊ¨°ËøêË°åÈÉΩ‰ºöÊ∂àËÄóÁÆóÂäõ
    #    Á≠æÂà∞Êú∫Âà∂Á°Æ‰øùËµÑÊ∫êÂàÜÈÖçÁªôÁúüÊ≠£ÈúÄË¶ÅÁöÑÁî®Êà∑ÔºåÊÑüË∞¢‰Ω†ÁöÑÁêÜËß£‰∏éÈÖçÂêà
    #    GitHub Actions is a shared public resource provided by the platform
    #    Check-in ensures resources go to those who truly need it ‚Äî thank you
    #
    # üöÄ ÈïøÊúü‰ΩøÁî®ËØ∑ÈÉ®ÁΩ≤ Docker ÁâàÊú¨ / For long-term use, deploy Docker version
    #
    # ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
    #
    # üìù ËøêË°åÊó∂Èó¥ËØ¥ÊòéÔºöÊØèÂ§©Âåó‰∫¨Êó∂Èó¥Êó©‰∏ä8ÁÇπËøêË°å
    # üìù Schedule: Daily 8:00 AM Beijing Time
    #
    # GitHub Actions ‰ΩøÁî® UTC Êó∂Èó¥ÔøΩÔøΩÔøΩÂåó‰∫¨Êó∂Èó¥ 8:00 = UTC 0:00
    # GitHub Actions uses UTC, Beijing 8:00 AM = UTC 0:00
    #
    # Á§∫‰æã / Examples:
    #   "0 0 * * *"       ‚Üí ÊØèÂ§©Âåó‰∫¨Êó∂Èó¥Êó©‰∏ä8ÁÇπ / Daily 8:00 AM Beijing
    #   "30 1 * * *"      ‚Üí ÊØèÂ§©Âåó‰∫¨Êó∂Èó¥Êó©‰∏ä9:30 / Daily 9:30 AM Beijing
    #
    - cron: "0 0 * * *"

  workflow_dispatch:

concurrency:
  group: crawler-${{ github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write
  pull-requests: write

jobs:
  crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true
          persist-credentials: true

      # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      # ËØïÁî®ÊúüÈôêÂà∂Â∑≤ÁßªÈô§ - ÂÆöÊó∂‰ªªÂä°Â∞ÜÊ∞∏‰πÖËøêË°å
      # Trial period limit removed - Scheduled tasks will run permanently
      # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

      # --------------------------------------------------------------------------------
      # üö¶ TRAFFIC CONTROL / ÊµÅÈáèÊéßÂà∂
      # --------------------------------------------------------------------------------
      # EN: Generates a random delay between 1 and 300 seconds (5 minutes).
      #     Critical for load balancing.
      #
      # CN: ÁîüÊàê 1 Âà∞ 300 ÁßíÔºà5ÂàÜÈíüÔºâ‰πãÈó¥ÁöÑÈöèÊú∫Âª∂Ëøü„ÄÇ
      #     ËøôÂØπË¥üËΩΩÂùáË°°Ëá≥ÂÖ≥ÈáçË¶Å„ÄÇ
      # - name: Random Delay (Traffic Control)
      #   if: success()
      #   run: |
      #     echo "üé≤ Traffic Control: Generating random delay..."
      #     DELAY=$(( ( RANDOM % 300 )  + 1 ))
      #     echo "‚è∏Ô∏è  Sleeping for ${DELAY} seconds to spread the load..."
      #     sleep ${DELAY}s
      #     echo "‚ñ∂Ô∏è  Delay finished. Starting crawler..."

      - name: Set up Python
        if: success()
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        if: success()
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify required files
        if: success()
        run: |
          if [ ! -f config/config.yaml ]; then
            echo "Error: Config missing"
            exit 1
          fi

      - name: Run crawler
        if: success()
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DINGTALK_WEBHOOK_URL: ${{ secrets.DINGTALK_WEBHOOK_URL }}
          WEWORK_WEBHOOK_URL: ${{ secrets.WEWORK_WEBHOOK_URL }}
          WEWORK_MSG_TYPE: ${{ secrets.WEWORK_MSG_TYPE }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER }}
          EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT }}
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
          NTFY_SERVER_URL: ${{ secrets.NTFY_SERVER_URL }}
          NTFY_TOKEN: ${{ secrets.NTFY_TOKEN }}
          BARK_URL: ${{ secrets.BARK_URL }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          # ÈÄöÁî®WebhookÈÖçÁΩÆ
          GENERIC_WEBHOOK_URL: ${{ secrets.GENERIC_WEBHOOK_URL }}
          GENERIC_WEBHOOK_TEMPLATE: ${{ secrets.GENERIC_WEBHOOK_TEMPLATE }}
          # AI ÈÖçÁΩÆÔºàai_analysis Âíå ai_translation ÂÖ±‰∫´Ê®°ÂûãÈÖçÁΩÆÔºâ
          AI_ANALYSIS_ENABLED: ${{ secrets.AI_ANALYSIS_ENABLED }}
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          AI_MODEL: ${{ secrets.AI_MODEL }}
          AI_API_BASE: ${{ secrets.AI_API_BASE }}
          # ËøúÁ®ãÂ≠òÂÇ®ÈÖçÁΩÆ
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
          S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
          S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
          S3_ENDPOINT_URL: ${{ secrets.S3_ENDPOINT_URL }}
          S3_REGION: ${{ secrets.S3_REGION }}
          # GitHub ÂêåÊ≠•ÈÖçÁΩÆ
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_ACTIONS: true
        run: python -m trendradar

      # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      # GitHub ÂêåÊ≠•Ê≠•È™§
      # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      - name: Sync data to GitHub
        if: success()
        run: |
          # Ê£ÄÊü•ÊòØÂê¶ÈÖçÁΩÆ‰∫Ü GH_TOKEN
          if [ -z "${{ secrets.GH_TOKEN }}" ]; then
            echo "GH_TOKEN Êú™ÈÖçÁΩÆÔºåË∑≥ËøáÂêåÊ≠•"
            exit 0
          fi

          echo "Ê≠£Âú®ÂêåÊ≠•Êï∞ÊçÆÂà∞ GitHub..."

          # Ëé∑ÂèñÂΩìÂâçÂàÜÊîØÁöÑ SHA
          BRANCH_SHA=$(gh api repos/18815292408/TrendRadar/git/ref/heads/main -q '.object.sha')
          echo "ÂΩìÂâçÂàÜÊîØ SHA: $BRANCH_SHA"

          # Ëé∑Âèñ‰ªäÂ§©ÁöÑÊó•Êúü
          TODAY=$(date +%Y-%m-%d)
          COMMIT_MSG="ÂêåÊ≠•ÁÉ≠ÁÇπÊï∞ÊçÆ - ${TODAY}"

          # Ê£ÄÊü• output/news ÁõÆÂΩïÊòØÂê¶Â≠òÂú®Êñ∞Êï∞ÊçÆ
          if [ ! -d "output/news" ] || [ -z "$(ls -A output/news 2>/dev/null)" ]; then
            echo "Ê≤°ÊúâÊï∞ÊçÆÊñá‰ª∂ÈúÄË¶ÅÂêåÊ≠•"
            exit 0
          fi

          echo "ÂèëÁé∞Êñ∞Êï∞ÊçÆÊñá‰ª∂..."

          # ÂàùÂßãÂåñ‰∏¥Êó∂ git ‰ªìÂ∫ìÊù•ÊûÑÂª∫Ê†ë
          TEMP_DIR=$(mktemp -d)
          cd "$TEMP_DIR"
          git init
          git remote add origin https://github.com/18815292408/TrendRadar.git
          git fetch --depth=1 origin $BRANCH_SHA 2>/dev/null || git fetch origin main
          git checkout $BRANCH_SHA 2>/dev/null || git checkout main

          # Â§çÂà∂Êñ∞Êï∞ÊçÆÊñá‰ª∂
          mkdir -p output/news
          cp -r /home/runner/work/TrendRadar/TrendRadar/output/news/* output/news/ 2>/dev/null || true

          # Ê∑ªÂä†Êñá‰ª∂Âà∞ git
          git add output/news/

          # Ëé∑ÂèñÊñá‰ª∂ÁöÑ SHA
          TREE_JSON="["
          first=true
          for file in $(git diff --cached --name-only); do
            blob_sha=$(git hash-object -w "$file")
            if [ "$first" = true ]; then
              first=false
            else
              TREE_JSON="${TREE_JSON},"
            fi
            TREE_JSON="${TREE_JSON}{\"path\":\"${file}\",\"mode\":\"100644\",\"type\":\"blob\",\"sha\":\"${blob_sha}\"}"
          done
          TREE_JSON="${TREE_JSON}]"

          # ÂàõÂª∫Ê†ë
          TREE_SHA=$(echo "$TREE_JSON" | gh api repos/18815292408/TrendRadar/git/trees -X POST --input - -q '.sha')
          echo "Êñ∞Ê†ë SHA: $TREE_SHA"

          # ÂàõÂª∫Êèê‰∫§
          COMMIT_SHA=$(gh api repos/18815292408/TrendRadar/git/commits -X POST --input - -q '.sha' << EOF
          {
            "message": "${COMMIT_MSG}",
            "author": {
              "name": "github-actions[bot]",
              "email": "github-actions[bot]@users.noreply.github.com"
            },
            "parents": ["${BRANCH_SHA}"],
            "tree": "${TREE_SHA}"
          }
          EOF
          )
          echo "Êèê‰∫§ SHA: $COMMIT_SHA"

          # Êõ¥Êñ∞ÂàÜÊîØÂºïÁî®
          if gh api repos/18815292408/TrendRadar/git/refs/heads/main -X PATCH --input - << EOF
          {
            "sha": "${COMMIT_SHA}",
            "force": true
          }
          EOF
          then
            echo "Êï∞ÊçÆÂêåÊ≠•ÊàêÂäüÔºÅ"
          else
            echo "ÂêåÊ≠•Â§±Ë¥•"
            exit 1
          fi
