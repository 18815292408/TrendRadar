name: Get Hot News

on:
  schedule:
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # ⚠️ 试用版说明 / Trial Mode
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    #
    # 🔄 运行机制 / How it works:
    #    - 每个周期为 7 天，届时自动停止
    #    - 运行 "Check In" 会重置周期（重新开始 7 天倒计时，而非累加）
    #    - Each cycle is 7 days, then auto-stops
    #    - "Check In" resets the cycle (restarts 7-day countdown, not cumulative)
    #
    # 💡 设计初衷 / Why this design:
    #    如果 7 天都忘了签到，或许这些资讯对你来说并非刚需
    #    适时的暂停，能帮你从信息流中抽离，给大脑留出喘息的空间
    #    If you forget for 7 days, maybe you don't really need it
    #    A timely pause helps you detach from the stream and gives your mind space
    #
    # 🙏 珍惜资源 / Respect shared resources:
    #    GitHub Actions 是平台提供的公共资源，每次运行都会消耗算力
    #    签到机制确保资源分配给真正需要的用户，感谢你的理解与配合
    #    GitHub Actions is a shared public resource provided by the platform
    #    Check-in ensures resources go to those who truly need it — thank you
    #
    # 🚀 长期使用请部署 Docker 版本 / For long-term use, deploy Docker version
    #
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    #
    # 📝 运行时间说明：每天北京时间早上8点运行
    # 📝 Schedule: Daily 8:00 AM Beijing Time
    #
    # GitHub Actions 使用 UTC 时间���北京时间 8:00 = UTC 0:00
    # GitHub Actions uses UTC, Beijing 8:00 AM = UTC 0:00
    #
    # 示例 / Examples:
    #   "0 0 * * *"       → 每天北京时间早上8点 / Daily 8:00 AM Beijing
    #   "30 1 * * *"      → 每天北京时间早上9:30 / Daily 9:30 AM Beijing
    #
    - cron: "0 0 * * *"

  workflow_dispatch:

concurrency:
  group: crawler-${{ github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write
  pull-requests: write

jobs:
  crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          clean: true
          persist-credentials: true

      # ═══════════════════════════════════════════════════════════════
      # 试用期限制已移除 - 定时任务将永久运行
      # Trial period limit removed - Scheduled tasks will run permanently
      # ═══════════════════════════════════════════════════════════════

      # --------------------------------------------------------------------------------
      # 🚦 TRAFFIC CONTROL / 流量控制
      # --------------------------------------------------------------------------------
      # EN: Generates a random delay between 1 and 300 seconds (5 minutes).
      #     Critical for load balancing.
      #
      # CN: 生成 1 到 300 秒（5分钟）之间的随机延迟。
      #     这对负载均衡至关重要。
      # - name: Random Delay (Traffic Control)
      #   if: success()
      #   run: |
      #     echo "🎲 Traffic Control: Generating random delay..."
      #     DELAY=$(( ( RANDOM % 300 )  + 1 ))
      #     echo "⏸️  Sleeping for ${DELAY} seconds to spread the load..."
      #     sleep ${DELAY}s
      #     echo "▶️  Delay finished. Starting crawler..."

      - name: Set up Python
        if: success()
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        if: success()
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify required files
        if: success()
        run: |
          if [ ! -f config/config.yaml ]; then
            echo "Error: Config missing"
            exit 1
          fi

      - name: Run crawler
        if: success()
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DINGTALK_WEBHOOK_URL: ${{ secrets.DINGTALK_WEBHOOK_URL }}
          WEWORK_WEBHOOK_URL: ${{ secrets.WEWORK_WEBHOOK_URL }}
          WEWORK_MSG_TYPE: ${{ secrets.WEWORK_MSG_TYPE }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER }}
          EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT }}
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
          NTFY_SERVER_URL: ${{ secrets.NTFY_SERVER_URL }}
          NTFY_TOKEN: ${{ secrets.NTFY_TOKEN }}
          BARK_URL: ${{ secrets.BARK_URL }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          # 通用Webhook配置
          GENERIC_WEBHOOK_URL: ${{ secrets.GENERIC_WEBHOOK_URL }}
          GENERIC_WEBHOOK_TEMPLATE: ${{ secrets.GENERIC_WEBHOOK_TEMPLATE }}
          # AI 配置（ai_analysis 和 ai_translation 共享模型配置）
          AI_ANALYSIS_ENABLED: ${{ secrets.AI_ANALYSIS_ENABLED }}
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          AI_MODEL: ${{ secrets.AI_MODEL }}
          AI_API_BASE: ${{ secrets.AI_API_BASE }}
          # 远程存储配置
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
          S3_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY_ID }}
          S3_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_ACCESS_KEY }}
          S3_ENDPOINT_URL: ${{ secrets.S3_ENDPOINT_URL }}
          S3_REGION: ${{ secrets.S3_REGION }}
          # GitHub 同步配置
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_ACTIONS: true
        run: python -m trendradar

      # ═══════════════════════════════════════════════════════════════
      # GitHub 同步步骤
      # ════════════════════════════════════════════════════════
      - name: Sync data to GitHub
        if: success()
        run: |
          # 检查是否配置了 GH_TOKEN
          if [ -z "${{ secrets.GH_TOKEN }}" ]; then
            echo "GH_TOKEN 未配置，跳过同步"
            exit 0
          fi

          echo "正在同步数据到 GitHub..."

          # 配置 Git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 使用自定义 token 配置 remote URL
          git remote set-url origin "https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/18815292408/TrendRadar.git"

          # 检出目标分支
          git fetch origin main || true

          # 检查是否有新数据需要同步
          if [ -d "output/news" ] && [ "$(ls -A output/news 2>/dev/null)" ]; then
            echo "发现新数据文件，添加到 Git..."

            # 获取今天的日期
            TODAY=$(date +%Y-%m-%d)
            COMMIT_MSG="同步热点数据 - ${TODAY}"

            # 添加所有新文件
            git add output/news/

            # 检查是否有变更
            if git diff --cached --quiet; then
              echo "没有新数据需要同步"
            else
              # 提交变更
              git commit -m "${COMMIT_MSG}"

              # 推送到远程
              if git push origin main; then
                echo "数据同步成功！"
              else
                echo "同步失败"
                exit 1
              fi
            fi
          else
            echo "没有数据文件需要同步"
          fi
